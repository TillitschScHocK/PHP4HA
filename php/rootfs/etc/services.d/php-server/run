#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: PHP Web Server
# Runs the PHP built-in web server
# ==============================================================================

# Get configuration
PORT=$(bashio::config 'port')
SUBDIR=$(bashio::config 'subdirectory')
PHP_DISPLAY_ERRORS=$(bashio::config 'php_display_errors')
PHP_MEMORY_LIMIT=$(bashio::config 'php_memory_limit')

# Set document root
DOCUMENT_ROOT="/config/www/${SUBDIR}"

bashio::log.info "Starting PHP Web Server..."
bashio::log.info "Port: ${PORT}"
bashio::log.info "Document Root: ${DOCUMENT_ROOT}"

# Create www directory if it doesn't exist
if [ ! -d "/config/www" ]; then
    bashio::log.info "Creating /config/www directory"
    mkdir -p /config/www
    chmod 755 /config/www
fi

# Create subdirectory if it doesn't exist
if [ ! -d "${DOCUMENT_ROOT}" ]; then
    bashio::log.info "Creating document root directory: ${DOCUMENT_ROOT}"
    mkdir -p "${DOCUMENT_ROOT}"
    chmod 755 "${DOCUMENT_ROOT}"
fi

# Create subdirectory if it doesn't exist
if [ ! -d "${DOCUMENT_ROOT}" ]; then
    bashio::log.info "Creating document root directory: ${DOCUMENT_ROOT}"
    mkdir -p "${DOCUMENT_ROOT}"
    chmod 755 "${DOCUMENT_ROOT}"
fi

# Create a default index.php if none exists
if [ ! -f "${DOCUMENT_ROOT}/index.php" ]; then
    bashio::log.info "Creating modern dashboard index.php"
    cat > "${DOCUMENT_ROOT}/index.php" << 'EOF'
<?php
    // --- ECHTE SYSTEM DATEN SAMMELN ---
    $dt = disk_total_space(".");
    $df = disk_free_space(".");
    $du = $dt - $df;
    $dp = sprintf('%.0f',($du / $dt) * 100);
    
    function formatSize($bytes) {
        $types = array( 'B', 'KB', 'MB', 'GB', 'TB' );
        for( $i = 0; $bytes >= 1024 && $i < ( count( $types ) -1 ); $bytes /= 1024, $i++ );
        return( round( $bytes, 2 ) . " " . $types[$i] );
    }

    // CPU Load (wenn verf√ºgbar)
    $load = sys_getloadavg();
    $cpu_load = isset($load[0]) ? $load[0] : 'N/A';

    // Uptime ermitteln
    $uptime = @file_get_contents('/proc/uptime');
    $uptime_str = "Unbekannt";
    if ($uptime) {
        $uptime_secs = explode(" ", $uptime)[0];
        $uptime_str = gmdate("H:i:s", (int)$uptime_secs);
    }
?>
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYSTEM // DASHBOARD</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #09090b;
            --card-bg: rgba(24, 24, 27, 0.6);
            --border: rgba(255, 255, 255, 0.08);
            --primary: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.4);
            --success: #10b981;
            --danger: #ef4444;
            --text-main: #e4e4e7;
            --text-muted: #71717a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(rgba(18, 18, 23, 0.9), rgba(18, 18, 23, 0.9)),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23222' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .dashboard {
            width: 100%;
            max-width: 1100px;
            animation: fadeIn 0.8s ease-out;
        }

        /* HEADER MIT SCAN LINE */
        .header {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; height: 2px; width: 100%;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            animation: scanline 3s infinite linear;
        }

        .title-group h1 {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -1px;
            text-transform: uppercase;
            background: linear-gradient(to right, #fff, var(--text-muted));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .live-badge {
            font-family: 'JetBrains Mono', monospace;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid rgba(16, 185, 129, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .blink {
            width: 8px; height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        /* GRID SYSTEM */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: rgba(255,255,255,0.2);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
        }

        .card-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        .card-value {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .sub-text {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* PROGRESS BAR F√úR DISK */
        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #60a5fa);
            width: <?php echo $dp; ?>%;
            box-shadow: 0 0 10px var(--primary-glow);
            transition: width 1s ease-in-out;
        }

        /* PHP INFO DETAILS */
        details {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
        }
        summary {
            padding: 20px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
            transition: color 0.2s;
        }
        summary:hover { color: var(--text-main); }
        .info-content {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: #fff;
            color: #111;
            overflow-x: auto;
        }

        /* ANIMATIONS */
        @keyframes scanline { 0% { left: -100%; } 100% { left: 100%; } }
        @keyframes blink { 0%, 100% { opacity: 1; box-shadow: 0 0 10px var(--success); } 50% { opacity: 0.4; box-shadow: none; } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        .clock-digit { display: inline-block; width: 0.6em; text-align: center; }
    </style>
</head>
<body>

    <div class="dashboard">
        <header class="header">
            <div class="title-group">
                <h1>Server Node</h1>
                <div class="sub-text">PHP <?php echo PHP_VERSION; ?> running on Linux</div>
            </div>
            <div class="live-badge">
                <div class="blink"></div> SYSTEM ONLINE
            </div>
        </header>

        <div class="grid">
            <div class="card">
                <div class="card-label">Lokale Zeit <span style="font-size:1.2em">‚è±</span></div>
                <div class="card-value" id="clock">--:--:--</div>
                <div class="sub-text" id="date">Lade...</div>
            </div>

            <div class="card">
                <div class="card-label">
                    Speicher (Disk) <span>üíæ</span>
                </div>
                <div class="card-value"><?php echo $dp; ?>%</div>
                <div class="sub-text">
                    <?php echo formatSize($df); ?> frei von <?php echo formatSize($dt); ?>
                </div>
                <div class="progress-container">
                    <div class="progress-bar"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-label">CPU Load Avg <span>‚ö°</span></div>
                <div class="card-value"><?php echo $cpu_load; ?></div>
                <div class="sub-text">Server Uptime: <?php echo $uptime_str; ?> (Std)</div>
            </div>

            <div class="card">
                <div class="card-label">Document Root <span>üìÇ</span></div>
                <div class="card-value" style="font-size: 1rem; color: var(--primary);">
                    <?php echo $_SERVER['DOCUMENT_ROOT']; ?>
                </div>
                <div class="sub-text">Schreibzugriff: <?php echo is_writable($_SERVER['DOCUMENT_ROOT']) ? '<span style="color:var(--success)">JA</span>' : '<span style="color:var(--danger)">NEIN</span>'; ?></div>
            </div>
        </div>

        <details>
            <summary>> sys_info --full</summary>
            <div class="info-content">
                <?php 
                ob_start();
                phpinfo();
                $pinfo = ob_get_contents();
                ob_end_clean();
                $pinfo = preg_replace('%^.*<body>(.*)</body>.*$%ms', '$1', $pinfo);
                echo $pinfo;
                ?>
            </div>
        </details>
    </div>

    <script>
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('de-DE');
            const dateString = now.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            document.getElementById('clock').innerText = timeString;
            document.getElementById('date').innerText = dateString;
        }
        
        setInterval(updateClock, 1000);
        updateClock();
    </script>
</body>
</html>
EOF
    chmod 644 "${DOCUMENT_ROOT}/index.php"
fi

# Set PHP configuration
export PHP_DISPLAY_ERRORS="${PHP_DISPLAY_ERRORS}"
export PHP_MEMORY_LIMIT="${PHP_MEMORY_LIMIT}"

bashio::log.info "==========================================="
bashio::log.info "PHP Web Server successfully started!"
bashio::log.info "URL: http://homeassistant.local:${PORT}"
bashio::log.info "Directory: ${DOCUMENT_ROOT}"
bashio::log.info "==========================================="

# Start PHP built-in web server
cd "${DOCUMENT_ROOT}" || exit 1
exec php -S 0.0.0.0:${PORT} \
    -d display_errors="${PHP_DISPLAY_ERRORS}" \
    -d memory_limit="${PHP_MEMORY_LIMIT}" \
    -d error_reporting=E_ALL \
    -d log_errors=1 \
    -d error_log="/proc/1/fd/1"
